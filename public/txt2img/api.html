<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>txt2img-API – Gen</title>
  <link rel="stylesheet" href="../mercury.css"/>
  <style>
    /* Optional: make the select look nicer */
    select#model {
      width: 100%;
      padding: 8px;
      font-size: 1em;
      border: 1px solid #444;
      border-radius: 4px;
      background: #222;
      color: #fff;
    }
  </style>
</head>
<body>
  <header class="top-bar">
  <a class="back" href="../txt2img.html">Back</a>
  <span class="title">txt2img-API</span>
</header>

  <div class="workbench">
    <aside class="panel left">
      <label>Prompt
        <textarea id="prompt" placeholder="generate an image of a..."></textarea>
      </label>
      <label>Model
        <select id="model">
          <option value="" disabled selected>Select a model</option>
          <option value="google/gemini-3-pro-image-preview">Gemini 3 Pro (nanobanana)</option>
          <option value="google/gemini-2.5-flash-image">Gemini 2.5</option>
          <option value="openai/gpt-5-image-mini">OpenAI gpt 5 mini</option>
          <option value="openai/gpt-5-image">OpenAI gpt 5</option>
        </select>
      </label>
      <button id="run" class="primary">Generate</button>
      <div class="loader hidden" id="loader">Crafting visuals…</div>
    </aside>

    <section class="panel right" id="gallery">
      <p class="placeholder">Images appear here</p>
    </section>
  </div>

<script>
const runBtn = document.getElementById('run');
const loader = document.getElementById('loader');
const gallery = document.getElementById('gallery');

// TODO: change THIS to your CLIP Text Encode node ID
const PROMPT_NODE_ID = "1";
const DRIVER_NODE_ID = "5"

let WORKFLOW = {}; // Declare WORKFLOW globally

const json_file = "api.json"

async function init() {
  try {
    // load the json workflow that represend the entire node graph.
    const response = await fetch(`../workflows/${json_file}`);
    WORKFLOW = await response.json();
    console.log("Workflow loaded:", WORKFLOW);
  } catch (error) {
    console.error("Error loading workflow:", error);
    alert(`Failed to load workflow. Please ensure '${json_file}' is in the 'workflows' folder.`);
  }
}

init(); // Load workflow when the page loads

runBtn.onclick = async () => {
  const prompt = document.getElementById('prompt').value;
  const model = document.getElementById('model').value;
  if (!prompt) { alert("Prompt required"); return; }
  if (!model) { alert("model required"); return; }

  const workflow = structuredClone(WORKFLOW);

  // inject prompt into workflow
  workflow[PROMPT_NODE_ID].inputs.STRING = prompt;
  workflow[DRIVER_NODE_ID].inputs.image_generation_model = model;

  // UI lock
  runBtn.disabled = true;
  loader.classList.remove('hidden');

  try {
    // send workflow to ComfyUI
    const response = await fetch("http://127.0.0.1:8188/prompt", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        prompt: workflow
      })
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json();
    console.log("Initial ComfyUI response:", data);

    if (data.prompt_id) {
      const promptId = data.prompt_id;
      let images = [];

      // Poll for status
      while (images.length === 0) {
        await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1 second
        const statusResponse = await fetch(`http://127.0.0.1:8188/history/${promptId}`);
        if (!statusResponse.ok) {
          throw new Error(`HTTP error! status: ${statusResponse.status} during polling`);
        }
        const statusData = await statusResponse.json();
        console.log("ComfyUI status:", statusData);

        if (statusData[promptId] && statusData[promptId].outputs) {
          for (const nodeId in statusData[promptId].outputs) {
            if (statusData[promptId].outputs[nodeId].images) {
              images = statusData[promptId].outputs[nodeId].images;
              break;
            }
          }
        }
      }

      gallery.innerHTML = "";
      images.forEach(image => {
        const url = `http://127.0.0.1:8188/view?filename=${image.filename}&subfolder=${image.subfolder}&type=${image.type}`;
        const img = document.createElement("img");
        img.src = url;
        gallery.appendChild(img);
      });

    } else {
      alert("Failed to get prompt_id from ComfyUI. Check console for details.");
    }
  } catch (error) {
    console.error("Error during image generation:", error);
    alert(`Image generation failed: ${error.message}. Please check ComfyUI server and CORS settings.`);
  } finally {
    loader.classList.add('hidden');
    runBtn.disabled = false;
  }
};
</script>
</body>
</html>